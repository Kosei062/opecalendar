<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>オペ管理カレンダー</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif; background: #fff; min-height: 100vh; padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
    .header { background: #667eea; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
    .header h1 { font-size: 20px; color: white; font-weight: 600; }
    .header-right { display: flex; gap: 8px; }

    .view-toggle, .menu-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      cursor: pointer;
      padding: 8px 16px;
      color: white;
      border-radius: 8px;
      transition: background 0.2s;
      font-size: 14px;
      font-weight: 600;
      width: 120px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      box-sizing: border-box;
    }
    .view-toggle:hover, .menu-btn:hover { background: rgba(255,255,255,0.3); }

    .menu-btn { font-size: 24px; padding: 8px 12px; width: 50px; }

    .container { max-width: 800px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
    .date-section { margin-bottom: 32px; }
    .date-header { background: #f8f9ff; padding: 14px 18px; border-radius: 12px; font-weight: 600; color: #667eea; font-size: 16px; margin-bottom: 12px; border: 2px solid #e8ebff; }
    .date-header.today { background: #f0f4ff; border-color: #667eea; font-weight: 700; }
    .card { background: white; padding: 18px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; border: 2px solid #e5e7eb; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .card:hover { box-shadow: 0 4px 12px rgba(102,126,234,0.15); border-color: #667eea; }
    .card.warning { border: 3px solid #ef4444; box-shadow: 0 2px 8px rgba(239,68,68,0.2); }
    .ope-card { display: flex; justify-content: space-between; align-items: flex-start; }
    .ope-card-left { flex: 1; min-width: 0; }
    .ope-title { font-size: 18px; font-weight: 700; color: #1f2937; margin-bottom: 10px; word-wrap: break-word; }
    .ope-info { font-size: 14px; color: #6b7280; line-height: 1.8; }
    .ope-instruments { margin-top: 8px; padding-top: 8px; border-top: 2px solid #f3f4f6; font-size: 14px; color: #4b5563; font-weight: 500; }
    .ope-card-right { display: flex; flex-direction: column; align-items: flex-end; gap: 10px; min-width: 110px; margin-left: 16px; }
    .pill { padding: 10px 16px; border-radius: 16px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; text-align: center; border: 2px solid transparent; }
    .pill:hover { transform: scale(1.05); }
    .time-pill { background: #667eea; color: white; border-color: #667eea; width: 100%; }
    .time-pill:hover { background: #5568d3; border-color: #5568d3; }
    .time-pill.unset { background: #f3f4f6; color: #9ca3af; border-color: #e5e7eb; }
    .time-pill.unset:hover { background: #e5e7eb; }
    .attendance-pills { display: flex; gap: 6px; width: 100%; }
    .attendance-pill { flex: 1; padding: 10px 8px; font-size: 13px; }
    .attendance-pill.present { background: #10b981; color: white; border-color: #10b981; }
    .attendance-pill.absent { background: #ef4444; color: white; border-color: #ef4444; }
    .attendance-pill.unset { background: #f3f4f6; color: #9ca3af; border-color: #e5e7eb; }
    .memo-pill { background: #fef3c7; color: #92400e; border-color: #fbbf24; width: 100%; font-size: 13px; }
    .memo-pill:hover { background: #fde68a; }
    .memo-pill.empty { background: #f3f4f6; color: #9ca3af; border-color: #e5e7eb; }
    .memo-pill.empty:hover { background: #e5e7eb; }
    .compact-card { padding: 12px 16px; margin-bottom: 8px; }
    .compact-title { font-size: 15px; font-weight: 600; color: #1f2937; }
    .compact-time { font-size: 13px; color: #6b7280; margin-top: 4px; }

    .fab { position: fixed; right: 20px; bottom: calc(20px + env(safe-area-inset-bottom)); width: 64px; height: 64px; border-radius: 50%; background: #667eea; color: white; border: none; font-size: 32px; cursor: pointer; box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4); transition: all 0.3s; z-index: 100; }
    .fab:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); }

    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 20px; padding: 28px; max-width: 500px; width: 100%; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .modal-header { font-size: 22px; font-weight: 700; margin-bottom: 24px; color: #1f2937; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 15px; font-weight: 600; color: #374151; margin-bottom: 8px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; font-family: inherit; transition: all 0.2s; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
    .form-group textarea { resize: vertical; min-height: 100px; }
    .form-row { display: flex; gap: 12px; }
    .form-row .form-group { flex: 1; margin-bottom: 20px; }
    .error-message { color: #ef4444; font-size: 14px; font-weight: 600; margin-top: 8px; display: none; }
    .error-message.show { display: block; }
    .form-group.error input { border-color: #ef4444; background: #fef2f2; }
    .modal-actions { display: flex; gap: 12px; margin-top: 28px; }
    .btn { flex: 1; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-secondary:hover { background: #d1d5db; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }

    .menu-dropdown { position: absolute; top: 70px; right: 20px; background: white; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); padding: 8px; display: none; z-index: 100; }
    .menu-dropdown.active { display: block; }
    .menu-item { padding: 14px 18px; cursor: pointer; border-radius: 12px; font-size: 15px; transition: background 0.2s; white-space: nowrap; font-weight: 500; }
    .menu-item:hover { background: #f3f4f6; }

    .empty-state { text-align: center; padding: 80px 20px; color: #6b7280; }
    .empty-state h2 { font-size: 24px; margin-bottom: 12px; color: #374151; }
    .empty-state p { font-size: 16px; }

    .time-select-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px; max-height: 50vh; overflow-y: auto; }
    .time-option { padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.2s; font-size: 14px; font-weight: 600; }
    .time-option:hover { border-color: #667eea; background: #f8f9ff; }
    .time-option.selected { background: #667eea; color: white; border-color: #667eea; }

    .quick-modal { padding: 24px; }
    .quick-modal .modal-header { margin-bottom: 20px; }

  </style>
</head>

<body>
  <div class="header">
    <h1>オペ管理カレンダー</h1>
    <div class="header-right">
      <button class="view-toggle" onclick="toggleView()">週表示</button>
      <button class="menu-btn" onclick="toggleMenu()">☰</button>
    </div>
  </div>

  <div class="menu-dropdown" id="menu">
    <div class="menu-item" onclick="exportData()">エクスポート</div>
    <div class="menu-item" onclick="importData()">インポート</div>
    <div class="menu-item" onclick="toggleLock()">ロック設定</div>
  </div>

  <div class="container" id="container"></div>
  <button class="fab" onclick="openAddModal()">+</button>

  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">新規オペ追加</div>
      <form id="opeForm" onsubmit="saveOpe(event)">

        <div class="form-group" id="titleGroup">
          <label>症例名 *</label>
          <input type="text" id="title">
          <div class="error-message" id="titleError">エラー</div>
        </div>

        <div class="form-row">
          <div class="form-group" id="dateGroup">
            <label>日付 *</label>
            <input type="date" id="date">
            <div class="error-message" id="dateError">エラー</div>
          </div>
          <div class="form-group">
            <label>時間</label>
            <input type="text" id="timeDisplay" readonly onclick="openTimeModalFromEdit()" placeholder="未設定" style="cursor: pointer; background: white;">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group"><label>担当医</label><input type="text" id="doctor"></div>
          <div class="form-group"><label>患者ID</label><input type="text" id="patientId"></div>
        </div>

        <div class="form-group"><label>器械（カンマ区切り）</label><input type="text" id="instruments" placeholder="例: A器械, B器械"></div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">キャンセル</button>
          <button type="button" class="btn btn-danger" id="deleteBtn" style="display:none" onclick="handleDelete()">削除</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>

      </form>
    </div>
  </div>

  <div class="modal" id="timeModal">
    <div class="modal-content quick-modal">
      <div class="modal-header">時間を選択</div>
      <div class="time-select-grid" id="timeGrid"></div>
      <div class="modal-actions" style="margin-top: 20px;">
        <button type="button" class="btn btn-secondary" onclick="closeTimeModal()">キャンセル</button>
        <button type="button" class="btn btn-danger" onclick="clearTime()">クリア</button>
        <button type="button" class="btn btn-primary" onclick="saveTime()">保存</button>
      </div>
    </div>
  </div>

  <div class="modal" id="memoModal">
    <div class="modal-content quick-modal">
      <div class="modal-header">メモ</div>
      <textarea id="memoText" style="width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; min-height: 150px; font-family: inherit;"></textarea>
      <div class="modal-actions" style="margin-top: 20px;">
        <button type="button" class="btn btn-secondary" onclick="closeMemoModal()">キャンセル</button>
        <button type="button" class="btn btn-primary" onclick="saveMemo()">保存</button>
      </div>
    </div>
  </div>

  <script>
    let ops=[], editId=null, viewMode='detailed', currId=null, selTime=null;
    function init(){checkLock();const d=localStorage.getItem('ops');if(d)ops=JSON.parse(d);render();genTimeGrid();}
    function genTimeGrid(){let h='';for(let i=0;i<24;i++){for(let m=0;m<60;m+=30){const t=pad(i)+':'+pad(m);h+='<div class="time-option" data-time="'+t+'" onclick="selectTime(\''+t+'\')">'+t+'</div>';}}document.getElementById('timeGrid').innerHTML=h;}
    function pad(n){return String(n).padStart(2,'0');}
    function saveOps(){localStorage.setItem('ops',JSON.stringify(ops));}
    function render(){const c=document.getElementById('container');if(ops.length===0){c.innerHTML='<div class="empty-state"><h2>オペ予定がありません</h2><p>右下の「+」ボタンから追加できます</p></div>';return;}viewMode==='weekly'?renderWeekly(c):renderDetailed(c);}
    function renderDetailed(c){const grouped={};ops.forEach(op=>{if(!grouped[op.date])grouped[op.date]=[];grouped[op.date].push(op);});const dates=Object.keys(grouped).sort();let h='';dates.forEach(d=>{const list=grouped[d];list.sort((a,b)=>!a.time?1:!b.time?-1:a.time.localeCompare(b.time));const isT=isToday(d);h+='<div class="date-section"><div class="date-header '+(isT?'today':'')+'">'+fmtDate(d)+(isT?' 【今日】':'')+'</div>';list.forEach(op=>{const warn=isWarn(op);h+='<div class="card ope-card '+(warn?'warning':'')+'" onclick="openEditModal(\''+op.id+'\')"><div class="ope-card-left"><div class="ope-title">'+esc(op.title)+'</div><div class="ope-info">';if(op.doctor)h+='担当医: '+esc(op.doctor)+'<br>';if(op.patientId)h+='患者ID: '+esc(op.patientId);h+='</div>';if(op.instruments)h+='<div class="ope-instruments">'+esc(op.instruments)+'</div>';h+='</div><div class="ope-card-right"><div class="pill time-pill '+(!op.time?'unset':'')+'" onclick="event.stopPropagation(); openTimeModal(\''+op.id+'\')">'+(op.time||'未設定')+'</div><div class="attendance-pills" onclick="event.stopPropagation()"><div class="pill attendance-pill '+(op.attendance==='present'?'present':'unset')+'" onclick="toggleAtt(\''+op.id+'\', \'present\')">あり</div><div class="pill attendance-pill '+(op.attendance==='absent'?'absent':'unset')+'" onclick="toggleAtt(\''+op.id+'\', \'absent\')">なし</div></div><div class="pill memo-pill '+(!op.memo?'empty':'')+'" onclick="event.stopPropagation(); openMemoModal(\''+op.id+'\')">メモ</div></div></div>';});h+='</div>';});c.innerHTML=h;}
    function renderWeekly(c){const today=new Date();today.setHours(0,0,0,0);const week=new Date(today);week.setDate(today.getDate()+7);const grouped={};ops.forEach(op=>{const od=new Date(op.date+'T00:00:00');if(od>=today&&od<week){if(!grouped[op.date])grouped[op.date]=[];grouped[op.date].push(op);}});const dates=Object.keys(grouped).sort();if(dates.length===0){c.innerHTML='<div class="empty-state"><h2>今後1週間のオペ予定がありません</h2></div>';return;}let h='';dates.forEach(d=>{const list=grouped[d];list.sort((a,b)=>!a.time?1:!b.time?-1:a.time.localeCompare(b.time));const isT=isToday(d);h+='<div class="date-section"><div class="date-header '+(isT?'today':'')+'">'+fmtDate(d)+(isT?' 【今日】':'')+'</div>';list.forEach(op=>{h+='<div class="card compact-card '+(isWarn(op)?'warning':'')+'" onclick="openEditModal(\''+op.id+'\')"><div class="compact-title">'+esc(op.title)+'</div>';if(op.time)h+='<div class="compact-time">'+op.time+'</div>';h+='</div>';});h+='</div>';});c.innerHTML=h;}
    function isToday(d){const t=new Date();t.setHours(0,0,0,0);const od=new Date(d+'T00:00:00');return t.getTime()===od.getTime();}
    function isWarn(op){const t=new Date();t.setHours(0,0,0,0);const od=new Date(op.date+'T00:00:00');const diff=Math.floor((od-t)/86400000);if(diff===1&&(!op.time||!op.attendance))return true;return!op.attendance;}
    function fmtDate(d){const dt=new Date(d+'T00:00:00');const days=['日','月','火','水','木','金','土'];return(dt.getMonth()+1)+'月'+dt.getDate()+'日（'+days[dt.getDay()]+'）';}
    function esc(t){const div=document.createElement('div');div.textContent=t;return div.innerHTML;}
    function openAddModal(){editId=null;document.getElementById('modalTitle').textContent='新規オペ追加';document.getElementById('opeForm').reset();document.getElementById('timeDisplay').value='';document.getElementById('deleteBtn').style.display='none';clearErrors();document.getElementById('modal').classList.add('active');}
    function openEditModal(id){editId=id;const op=ops.find(o=>o.id===id);if(!op)return;document.getElementById('modalTitle').textContent='オペ編集';document.getElementById('title').value=op.title;document.getElementById('date').value=op.date;document.getElementById('timeDisplay').value=op.time||'';document.getElementById('doctor').value=op.doctor||'';document.getElementById('patientId').value=op.patientId||'';document.getElementById('instruments').value=op.instruments||'';document.getElementById('deleteBtn').style.display='block';clearErrors();document.getElementById('modal').classList.add('active');}
    function closeModal(){document.getElementById('modal').classList.remove('active');}
    function clearErrors(){document.getElementById('titleGroup').classList.remove('error');document.getElementById('titleError').classList.remove('show');document.getElementById('dateGroup').classList.remove('error');document.getElementById('dateError').classList.remove('show');}
    function saveOpe(e){e.preventDefault();const title=document.getElementById('title').value.trim();const date=document.getElementById('date').value;let err=false;if(!title){document.getElementById('titleGroup').classList.add('error');document.getElementById('titleError').classList.add('show');err=true;}else{document.getElementById('titleGroup').classList.remove('error');document.getElementById('titleError').classList.remove('show');}if(!date){document.getElementById('dateGroup').classList.add('error');document.getElementById('dateError').classList.add('show');err=true;}else{document.getElementById('dateGroup').classList.remove('error');document.getElementById('dateError').classList.remove('show');}if(err)return;let op;if(editId){op=ops.find(o=>o.id===editId);if(!op)return;op.title=title;op.date=date;op.doctor=document.getElementById('doctor').value;op.patientId=document.getElementById('patientId').value;op.instruments=document.getElementById('instruments').value;}else{op={id:Date.now().toString(),title:title,date:date,time:document.getElementById('timeDisplay').value||'',doctor:document.getElementById('doctor').value,patientId:document.getElementById('patientId').value,instruments:document.getElementById('instruments').value,attendance:'',memo:''};ops.push(op);}saveOps();closeModal();render();}
    function handleDelete(){if(!editId)return;const op=ops.find(o=>o.id===editId);if(!op)return;if(!confirm('「'+op.title+'」を削除してもよろしいですか？'))return;const idx=ops.findIndex(o=>o.id===editId);if(idx!==-1){ops.splice(idx,1);saveOps();closeModal();render();}}
    function toggleAtt(id,val){const op=ops.find(o=>o.id===id);if(!op)return;op.attendance=op.attendance===val?'':val;saveOps();render();}
    function openTimeModal(id){currId=id;const op=ops.find(o=>o.id===id);selTime=op?op.time:null;document.querySelectorAll('.time-option').forEach(el=>{el.classList.remove('selected');if(op&&op.time===el.dataset.time)el.classList.add('selected');});document.getElementById('timeModal').classList.add('active');}
    function openTimeModalFromEdit(){currId=editId||'temp';const td=document.getElementById('timeDisplay').value;selTime=td||null;document.querySelectorAll('.time-option').forEach(el=>{el.classList.remove('selected');if(td&&td===el.dataset.time)el.classList.add('selected');});document.getElementById('timeModal').classList.add('active');}
    function selectTime(t){selTime=t;document.querySelectorAll('.time-option').forEach(el=>{el.classList.remove('selected');if(el.dataset.time===t)el.classList.add('selected');});}
    function saveTime(){if(selTime){if(currId==='temp'){document.getElementById('timeDisplay').value=selTime;}else if(currId){const op=ops.find(o=>o.id===currId);if(op){op.time=selTime;saveOps();render();}if(editId===currId)document.getElementById('timeDisplay').value=selTime;}}closeTimeModal();}
    function clearTime(){if(currId==='temp'){document.getElementById('timeDisplay').value='';}else if(currId){const op=ops.find(o=>o.id===currId);if(op){op.time='';saveOps();render();}if(editId===currId)document.getElementById('timeDisplay').value='';}closeTimeModal();}
    function closeTimeModal(){document.getElementById('timeModal').classList.remove('active');currId=null;selTime=null;}
    function openMemoModal(id){currId=id;const op=ops.find(o=>o.id===id);document.getElementById('memoText').value=op?(op.memo||''):'';document.getElementById('memoModal').classList.add('active');}
    function saveMemo(){if(currId){const op=ops.find(o=>o.id===currId);if(op){op.memo=document.getElementById('memoText').value;saveOps();render();}}closeMemoModal();}
    function closeMemoModal(){document.getElementById('memoModal').classList.remove('active');currId=null;}
    function toggleView(){const btn=document.querySelector('.view-toggle');if(viewMode==='detailed'){viewMode='weekly';btn.textContent='詳細表示';}else{viewMode='detailed';btn.textContent='週表示';}render();}
    function toggleMenu(){document.getElementById('menu').classList.toggle('active');}
    function exportData(){const json=JSON.stringify(ops,null,2);const uri='data:application/json;charset=utf-8,'+encodeURIComponent(json);const name='ope-data-'+new Date().toISOString().split('T')[0]+'.json';const a=document.createElement('a');a.setAttribute('href',uri);a.setAttribute('download',name);a.click();toggleMenu();}
    function importData(){const input=document.createElement('input');input.type='file';input.accept='application/json';input.onchange=function(e){const file=e.target.files[0];const reader=new FileReader();reader.onload=function(ev){try{const data=JSON.parse(ev.target.result);if(confirm('データをインポートしますか？現在のデータは上書きされます。')){ops=data;saveOps();render();}}catch(err){alert('ファイルの読み込みに失敗しました');}};reader.readAsText(file);};input.click();toggleMenu();}
    function toggleLock(){const hash=localStorage.getItem('lockHash');if(hash){if(confirm('ロックを解除しますか？')){localStorage.removeItem('lockHash');alert('ロックを解除しました');}}else{const pw=prompt('パスワードを設定してください:');if(pw){hashPw(pw).then(function(h){localStorage.setItem('lockHash',h);alert('ロックを設定しました');});}}toggleMenu();}
    function checkLock(){const hash=localStorage.getItem('lockHash');if(hash){const input=prompt('パスワードを入力してください:');if(input){hashPw(input).then(h=>{if(h!==hash){alert('パスワードが間違っています');checkLock();}});}else{checkLock();}}}
    async function hashPw(pw){const buf=new TextEncoder().encode(pw);const hash=await crypto.subtle.digest('SHA-256',buf);const arr=Array.from(new Uint8Array(hash));return arr.map(b=>b.toString(16).padStart(2,'0')).join('');}
    document.addEventListener('click',function(e){const menu=document.getElementById('menu');const btn=document.querySelector('.menu-btn');if(!menu.contains(e.target)&&!btn.contains(e.target)){menu.classList.remove('active');}});
    init();
  </script>

</body>
</html>